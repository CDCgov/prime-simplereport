package gov.cdc.usds.simplereport.api.pxp;

import gov.cdc.usds.simplereport.api.model.errors.ExpiredPatientLinkException;
import gov.cdc.usds.simplereport.api.model.errors.MissingDataPatientLinkException;
import gov.cdc.usds.simplereport.api.model.pxp.PxpRequestWrapper;
import gov.cdc.usds.simplereport.api.model.pxp.PxpTestResultUnauthenticatedResponse;
import gov.cdc.usds.simplereport.api.model.pxp.PxpVerifyResponseV2;
import gov.cdc.usds.simplereport.db.model.Facility;
import gov.cdc.usds.simplereport.db.model.Person;
import gov.cdc.usds.simplereport.db.model.Result;
import gov.cdc.usds.simplereport.db.model.TestEvent;
import gov.cdc.usds.simplereport.db.model.TestOrder;
import gov.cdc.usds.simplereport.db.repository.TestEventRepository;
import gov.cdc.usds.simplereport.service.DiseaseService;
import gov.cdc.usds.simplereport.service.PatientLinkService;
import gov.cdc.usds.simplereport.service.TimeOfConsentService;
import java.util.NoSuchElementException;
import java.util.Optional;
import java.util.UUID;
import javax.annotation.PostConstruct;
import javax.servlet.http.HttpServletRequest;
import lombok.extern.slf4j.Slf4j;
import org.springframework.security.access.prepost.PostAuthorize;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.validation.annotation.Validated;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

/**
 * Note that this controller self-authorizes by means of this {@link PreAuthorize} annotation and
 * its routes are set to permitAll() in SecurityConfiguration. If this changes, please update the
 * documentation on both sides.
 *
 * <p>Similarly, this controller sends information to the audit log via a {@link PostAuthorize}.
 * Because of this, every handler method of this controller is required to have an {@link
 * HttpServletRequest} argument named {@code request}.
 */
@PostAuthorize("@restAuditLogManager.logRestSuccess(#request, returnObject)")
@RestController
@RequestMapping("/pxp")
@Validated
@Slf4j
public class PatientExperienceController {
  private final PatientLinkService _pls;
  private final TimeOfConsentService _tocs;
  private final CurrentPatientContextHolder _contextHolder;
  private final DiseaseService _diseaseService;
  private final TestEventRepository _testEventRepository;

  public PatientExperienceController(
      PatientLinkService patientLinkService,
      TimeOfConsentService timeOfConsentService,
      CurrentPatientContextHolder contextHolder,
      DiseaseService diseaseService,
      TestEventRepository testEventRepository) {
    this._pls = patientLinkService;
    this._tocs = timeOfConsentService;
    this._contextHolder = contextHolder;
    this._diseaseService = diseaseService;
    this._testEventRepository = testEventRepository;
  }

  @PostConstruct
  private void init() {
    log.info("Patient Experience REST endpoints enabled");
  }

  /** Verify that the patient-provided DOB matches the patient on file for the patient link id. */
  @PreAuthorize(
      "@patientLinkService.verifyPatientLink(#body.getPatientLinkId(), #body.getDateOfBirth())")
  @PostMapping("/link/verify/v2")
  public PxpVerifyResponseV2 getPatientLinkVerifyV2(
      @RequestBody PxpRequestWrapper<Void> body, HttpServletRequest request) {
    Person patient = _contextHolder.getPatient();
    TestEvent testEvent = _contextHolder.getLinkedOrder().getTestEvent();
    _tocs.storeTimeOfConsent(_contextHolder.getPatientLink());

    Optional<Result> optionalResult = testEvent.getResultForDisease(_diseaseService.covid());
    Result covidResult;
    if (optionalResult.isPresent()) {
      covidResult = optionalResult.get();
    } else {
      try {
        Optional<TestEvent> originalEventOptional =
            _testEventRepository.findById(testEvent.getPriorCorrectedTestEventId());
        TestEvent originalEvent =
            originalEventOptional.orElseThrow(MissingDataPatientLinkException::new);
        covidResult =
            originalEvent
                .getResultForDisease(_diseaseService.covid())
                .orElseThrow(MissingDataPatientLinkException::new);
      } catch (NoSuchElementException | NullPointerException e) {
        throw new MissingDataPatientLinkException();
      }
    }

    Optional<Result> fluAResult = testEvent.getResultForDisease(_diseaseService.fluA());
    Optional<Result> fluBResult = testEvent.getResultForDisease(_diseaseService.fluB());

    return new PxpVerifyResponseV2(patient, testEvent, covidResult, fluAResult, fluBResult);
  }

  /**
   * Given a patient link ID, returns a minimum of information about the patient (obfuscated name)
   * and facility (name and phone number) that may aid the end user in identify verification.
   *
   * <p>This endpoint is unauthorized and therefore does not return fully identifying data.
   */
  @GetMapping("/entity")
  public PxpTestResultUnauthenticatedResponse getTestResultUnauthenticated(
      @RequestParam("patientLink") UUID patientLink, HttpServletRequest request)
      throws ExpiredPatientLinkException {
    var link = _pls.getPatientLink(patientLink);

    if (link.isExpired()) {
      throw new ExpiredPatientLinkException();
    }

    TestOrder to = link.getTestOrder();
    Person p = to.getPatient();
    Facility f = to.getFacility();

    _contextHolder.setContext(link, to, p);

    return new PxpTestResultUnauthenticatedResponse(p, f, link);
  }
}
