x-ref-data:
  type-defs:
    - &idtype uuid
    - &string text
  column-defs:
    - column: &pk_column
        name: internal_id
        type: *idtype
        remarks: The internal database identifier for this entity.
        constraints:
          primaryKey: true
          nullable: false
    - column: &created_at_column
        name: created_at
        type: DATETIME
        remarks: The creation timestamp for this entity.
        constraints:
          nullable: false
    - column: &updated_at_column
        name: updated_at
        type: DATETIME
        remarks: The timestamp for the most recent update of this entity.
        constraints:
          nullable: false
    - column: &created_by_column
        name: created_by
        type: *idtype
        remarks: The user who created this entity.
        constraints:
          nullable: false
          foreignKeyName: fk__anyentity__created_by # normally we make these unique, but that's a lot of boilerpate
          references: api_user
    - column: &updated_by_column
        name: updated_by
        type: *idtype
        remarks: The user who most recently updated this entity.
        constraints:
          nullable: false
          references: api_user
          foreignKeyName: fk__anyentity__updated_by
    - column: &soft_delete_column
        name: is_deleted
        type: boolean
        remarks: Flag for soft-deletion of entities (false unless the entity has been deleted).
        constraints:
          nullable: false
databaseChangeLog:
  - property:
      name: migrations_user_email
      value: usds@cdc.gov
  - changeSet:
      id: define-enum-types
      author: bwarfield@cdc.gov
      comment: Type definitions for our initial tables.
      changes:
        - sql:
            remarks: Create the enumerations needed for tracking test orders.
            # these may need to be tweaked if we ever might care about their sort order
            sql: |
              CREATE TYPE ${database.defaultSchemaName}.TEST_ORDER_STATUS as ENUM('PENDING', 'COMPLETED', 'CANCELED');
              CREATE TYPE ${database.defaultSchemaName}.TEST_RESULT as ENUM('POSITIVE','NEGATIVE','UNDETERMINED');
      rollback:
        sql: |
          DROP TYPE ${database.defaultSchemaName}.TEST_ORDER_STATUS;
          DROP TYPE ${database.defaultSchemaName}.TEST_RESULT;
  - changeSet:
      id: initial-schema
      author: bwarfield@cdc.gov
      comment: The database schema required for the initial deployment of the Simple Report API.
      changes:
        - createTable:
            tableName: api_user
            remarks: Any user who authenticates to the API to take actions using it.
            columns:
              - column:
                  name: internal_id
                  type: *idtype
                  remarks: The internal database identifier for this entity.
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: created_at
                  type: DATETIME
                  remarks: The creation timestamp for this entity.
                  constraints:
                    nullable: false
              - column:
                  name: updated_at
                  type: DATETIME
                  remarks: The timestamp for the most recent update of this entity.
                  constraints:
                    nullable: false
              - column:
                  name: login_email
                  type: *string
                  remarks: The e-mail of the logged-in user, assuming that is our unique ID for users.
                  constraints:
                    unique: true
                    nullable: false
              - column:
                  name: last_seen
                  type: DATETIME
                  remarks: The last time this user connected to the API.
                  constraints:
                    nullable: false
              - column:
                  name: first_name
                  remarks: The user's given name, if any (to be derived from authentication claims).
                  type: *string
              - column:
                  name: middle_name
                  remarks: The user's middle name, if any (to be derived from authentication claims).
                  type: *string
              - column:
                  name: last_name
                  remarks: The user's family name or only name (to be derived from authentication claims).
                  type: *string
                  constraints:
                    nullable: false
              - column:
                  name: suffix
                  remarks: The generational or positional designation appended to the user's name.
                  type: *string
        - createTable:
            tableName: device_type
            remarks: Testing devices that may be present.
            columns:
              - column:
                  name: internal_id
                  type: *idtype
                  remarks: The internal database identifier for this entity.
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: created_at
                  type: DATETIME
                  remarks: The creation timestamp for this entity.
                  constraints:
                    nullable: false
              - column:
                  name: created_by
                  type: *idtype
                  remarks: The user who created this entity.
                  constraints:
                    nullable: false
                    foreignKeyName: fk__anyentity__created_by
                    references: api_user
              - column:
                  name: updated_at
                  type: DATETIME
                  remarks: The timestamp for the most recent update of this entity.
                  constraints:
                    nullable: false
              - column:
                  name: updated_by
                  type: *idtype
                  remarks: The user who most recently updated this entity.
                  constraints:
                    nullable: false
                    references: api_user
                    foreignKeyName: fk__anyentity__updated_by
              - column:
                  name: is_deleted
                  type: boolean
                  remarks: Flag for soft-deletion of entities (false unless the entity has been deleted).
                  constraints:
                    nullable: false
              - column:
                  name: name
                  type: *string
                  remarks: The name of the device, as displayed in isolation
                  constraints:
                    nullable: false
                    unique: true
                    uniqueConstraintName: uk__device_type
              - column:
                  name: loinc_code
                  type: *string
                  remarks: The LOINC code for this device, for reporting purposes (sadly, not unique)
                  constraints:
                    nullable: false
              - column:
                  name: manufacturer
                  remarks: The manufacturer of the device.
                  type: *string
              - column:
                  name: model
                  type: *string
                  remarks: The device model name.
        - createTable:
            tableName: provider
            remarks: A provider who can (we hope) write test orders.
            columns:
              - column:
                  name: internal_id
                  type: *idtype
                  remarks: The internal database identifier for this entity.
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: created_at
                  type: DATETIME
                  remarks: The creation timestamp for this entity.
                  constraints:
                    nullable: false
              - column:
                  name: created_by
                  type: *idtype
                  remarks: The user who created this entity.
                  constraints:
                    nullable: false
                    foreignKeyName: fk__anyentity__created_by
                    references: api_user
              - column:
                  name: updated_at
                  type: DATETIME
                  remarks: The timestamp for the most recent update of this entity.
                  constraints:
                    nullable: false
              - column:
                  name: updated_by
                  type: *idtype
                  remarks: The user who most recently updated this entity.
                  constraints:
                    nullable: false
                    references: api_user
                    foreignKeyName: fk__anyentity__updated_by
              - column:
                  name: is_deleted
                  type: boolean
                  remarks: Flag for soft-deletion of entities (false unless the entity has been deleted).
                  constraints:
                    nullable: false
              - column:
                  name: first_name
                  remarks: The provider's given name, if any.
                  type: *string
              - column:
                  name: middle_name
                  remarks: The provider's middle name, if any.
                  type: *string
              - column:
                  name: last_name
                  remarks: The provider's family name or only name.
                  type: *string
                  constraints:
                    nullable: false
              - column:
                  name: suffix
                  remarks: generational or positional designations appended to the provider's name
                  type: *string
              - column:
                  name: provider_id
                  remarks: The external ID (NPI) for this provider.
                  type: *string
                  constraints:
                    nullable: false
              - column:
                  name: street
                  remarks: The street portion of the person's address.
                  type: "text[]"
              - column:
                  name: city
                  remarks: The city of the provider's address.
                  type: *string
              - column:
                  name: county
                  remarks: The county (NOT THE COUNTRY) of the provider's address, if applicable.
                  type: *string
              - column:
                  name: state
                  remarks: The state or province of the provider's address.
                  type: *string
              - column:
                  name: postal_code
                  remarks: The zip/postal code of the provider's address.
                  type: *string
              - column:
                  name: telephone
                  remarks: The provider's contact phone number.
                  type: *string
        - createTable:
            tableName: organization
            remarks: A site where testing occurs, and also the main user grouping entity.
            columns:
              - column:
                  name: internal_id
                  type: *idtype
                  remarks: The internal database identifier for this entity.
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: created_at
                  type: DATETIME
                  remarks: The creation timestamp for this entity.
                  constraints:
                    nullable: false
              - column:
                  name: created_by
                  type: *idtype
                  remarks: The user who created this entity.
                  constraints:
                    nullable: false
                    foreignKeyName: fk__anyentity__created_by
                    references: api_user
              - column:
                  name: updated_at
                  type: DATETIME
                  remarks: The timestamp for the most recent update of this entity.
                  constraints:
                    nullable: false
              - column:
                  name: updated_by
                  type: *idtype
                  remarks: The user who most recently updated this entity.
                  constraints:
                    nullable: false
                    references: api_user
                    foreignKeyName: fk__anyentity__updated_by
              - column:
                  name: is_deleted
                  type: boolean
                  remarks: Flag for soft-deletion of entities (false unless the entity has been deleted).
                  constraints:
                    nullable: false
              - column:
                  name: facility_name
                  type: *string
                  remarks: The human-readable name for this facility.
                  constraints:
                    nullable: false
                    unique: true
                    uniqueConstraintName: uk__facility__name
              - column:
                  name: organization_external_id
                  type: *string
                  remarks: The external ID of the organization, for authorization purposes.
                  constraints:
                    nullable: false
                    unique: true
                    uniqueConstraintName: uk__facility__organization_id
              - column:
                  name: clia_number
                  type: *string # irony
                  remarks: The CLIA number for the facility that is ordering (and presumably also conducting) the tests.
                  constraints:
                    nullable: false
              - column:
                  name: default_device_type
                  remarks: The default device type (if any) for tests at this facility.
                  type: *idtype
                  constraints:
                    foreignKeyName: fk__organization__default_device_type
                    references: device_type
              - column:
                  name: ordering_provider_id
                  type: *idtype
                  remarks: at what point does this blow up on me?
                  constraints:
                    nullable: false
                    foreignKeyName: fk__organization__ordering_provider
                    references: provider
        - createTable:
            tableName: facility_device_type
            remarks: Many-to-many table for device configuration at a facility.
            columns:
              - column:
                  name: organization_id
                  type: *idtype
                  constraints:
                    nullable: false
                    foreignKeyName: fk__facility_device_type__organization
                    references: organization
              - column:
                  name: device_type_id
                  type: *idtype
                  constraints:
                    nullable: false
                    foreignKeyName: fk__facility_device_type__device_type
                    references: device_type
        - createTable:
            tableName: person
            remarks: The personal information we store about users and patients
            columns:
              - column:
                  name: internal_id
                  type: *idtype
                  remarks: The internal database identifier for this entity.
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: created_at
                  type: DATETIME
                  remarks: The creation timestamp for this entity.
                  constraints:
                    nullable: false
              - column:
                  name: created_by
                  type: *idtype
                  remarks: The user who created this entity.
                  constraints:
                    nullable: false
                    foreignKeyName: fk__anyentity__created_by
                    references: api_user
              - column:
                  name: updated_at
                  type: DATETIME
                  remarks: The timestamp for the most recent update of this entity.
                  constraints:
                    nullable: false
              - column:
                  name: updated_by
                  type: *idtype
                  remarks: The user who most recently updated this entity.
                  constraints:
                    nullable: false
                    references: api_user
                    foreignKeyName: fk__anyentity__updated_by
              - column:
                  name: is_deleted
                  type: boolean
                  remarks: Flag for soft-deletion of entities (false unless the entity has been deleted).
                  constraints:
                    nullable: false
              - column:
                  name: organization_id
                  remarks: Foreign key to the facility/organization responsible for entering this person's information.
                  type: *idtype
                  constraints:
                    nullable: false
                    foreignKeyName: fk__person__organization
                    references: organization
              - column:
                  name: first_name
                  remarks: The person's given name, if any.
                  type: *string
              - column:
                  name: middle_name
                  remarks: The person's middle name, if any.
                  type: *string
              - column:
                  name: last_name
                  remarks: The person's family name or only name.
                  type: *string
                  constraints:
                    nullable: false
              - column:
                  name: suffix
                  remarks: The generational or positional designations appended to the person's name.
                  type: *string
              - column:
                  name: race
                  remarks: grouping of humans based on shared physical or social qualities
                  type: "text[]"
              - column:
                  name: gender
                  remarks: biological sex
                  type: *string
              - column:
                  name: ethnicity
                  remarks: ethnic group
                  type: *string
              - column:
                  name: lookup_id
                  remarks: user entered. hopefully unique. patient identifier used for patient search
                  type: *string
              - column:
                  name: birth_date
                  remarks: The person's date of birth.
                  type: DATE
                  constraints:
                    nullable: true
              - column:
                  name: street
                  remarks: The street portion of the person's address.
                  type: "text[]"
              - column:
                  name: city
                  remarks: The city of the person's address.
                  type: *string
              - column:
                  name: county
                  remarks: The county (NOT THE COUNTRY) of the person's address, if applicable.
                  type: *string
              - column:
                  name: state
                  remarks: The state or province of the person's address.
                  type: *string
              - column:
                  name: postal_code
                  remarks: The zip/postal code of the person's address.
                  type: *string
              - column:
                  name: telephone
                  remarks: The person's contact phone number.
                  type: *string
              - column:
                  name: email
                  remarks: The person's contact email.
                  type: *string
              - column:
                  name: employed_in_healthcare
                  remarks: Is the person employed in healthcare?
                  type: boolean
              - column:
                  name: role
                  remarks: The person's role at the facility where they are tested (e.g. "staff", "visitor", "resident").
                  type: *string
              - column:
                  name: resident_congregate_setting
                  remarks: Does the person live in a congregate setting?
                  type: boolean
        - createTable:
            tableName: patient_answers
            columns:
              - column:
                  name: internal_id
                  type: *idtype
                  remarks: The internal database identifier for this entity.
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: created_at
                  type: DATETIME
                  remarks: The creation timestamp for this entity.
                  constraints:
                    nullable: false
              - column:
                  name: created_by
                  type: *idtype
                  remarks: The user who created this entity.
                  constraints:
                    nullable: false
                    foreignKeyName: fk__anyentity__created_by
                    references: api_user
              - column:
                  name: updated_at
                  type: DATETIME
                  remarks: The timestamp for the most recent update of this entity.
                  constraints:
                    nullable: false
              - column:
                  name: updated_by
                  type: *idtype
                  remarks: The user who most recently updated this entity.
                  constraints:
                    nullable: false
                    references: api_user
                    foreignKeyName: fk__anyentity__updated_by
              - column:
                  name: ask_on_entry
                  type: jsonb
                  remarks: The questions asked at order entry or at test time.
        - createTable:
            tableName: test_event
            columns:
              - column:
                  name: internal_id
                  type: *idtype
                  remarks: The internal database identifier for this entity.
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: created_at
                  type: DATETIME
                  remarks: The creation timestamp for this entity.
                  constraints:
                    nullable: false
              - column:
                  name: created_by
                  type: *idtype
                  remarks: The user who created this entity.
                  constraints:
                    nullable: false
                    foreignKeyName: fk__anyentity__created_by
                    references: api_user
              - column:
                  name: updated_at
                  type: DATETIME
                  remarks: The timestamp for the most recent update of this entity.
                  constraints:
                    nullable: false
              - column:
                  name: updated_by
                  type: *idtype
                  remarks: The user who most recently updated this entity.
                  constraints:
                    nullable: false
                    references: api_user
                    foreignKeyName: fk__anyentity__updated_by
              - column:
                  name: patient_id
                  remarks: The person who is being given the test.
                  type: *idtype
                  constraints:
                    nullable: false
                    foreignKeyName: fk__test_event__patient__person
                    references: person
              - column:
                  name: organization_id
                  remarks: Foreign key to the facility/organization responsible for entering this person's information.
                  type: *idtype
                  constraints:
                    nullable: false
                    foreignKeyName: fk__test_event__organization
                    references: organization
              - column:
                  name: device_type_id
                  remarks: The device used to record the test result.
                  type: *idtype
                  constraints:
                    foreignKeyName: fk__test_event__device_type
                    references: device_type
              - column:
                  name: patient_data
                  type: jsonb
                  remarks: The patient's demographics and address at the time the test was administered.
              - column:
                  name: provider_data
                  type: jsonb
                  remarks: The name and contact of the provider who ordered the test.
              - column:
                  name: result
                  remarks: The result of the test, once it has been given.
                  type: ${database.defaultSchemaName}.TEST_RESULT
        - createTable:
            tableName: test_order
            remarks: Test orders, whether pending, completed or canceled.
            columns:
              - column:
                  name: internal_id
                  type: *idtype
                  remarks: The internal database identifier for this entity.
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: created_at
                  type: DATETIME
                  remarks: The creation timestamp for this entity.
                  constraints:
                    nullable: false
              - column:
                  name: created_by
                  type: *idtype
                  remarks: The user who created this entity.
                  constraints:
                    nullable: false
                    foreignKeyName: fk__anyentity__created_by
                    references: api_user
              - column:
                  name: updated_at
                  type: DATETIME
                  remarks: The timestamp for the most recent update of this entity.
                  constraints:
                    nullable: false
              - column:
                  name: updated_by
                  type: *idtype
                  remarks: The user who most recently updated this entity.
                  constraints:
                    nullable: false
                    references: api_user
                    foreignKeyName: fk__anyentity__updated_by
              - column:
                  name: patient_id
                  remarks: The person who is being given the test.
                  type: *idtype
                  constraints:
                    nullable: false
                    foreignKeyName: fk__test_order__patient__person
                    references: person
              - column:
                  name: organization_id
                  remarks: Foreign key to the facility/organization responsible for entering this person's information.
                  type: *idtype
                  constraints:
                    nullable: false
                    foreignKeyName: fk__test_order__organization
                    references: organization
              - column:
                  name: patient_answers_id
                  remarks: The questions asked at order entry or at test time.
                  type: *idtype
                  constraints:
                    foreignKeyName: fk__test_order__patient_answers
                    references: patient_answers
              - column:
                  name: device_type_id
                  remarks: The device used to record the test result
                  type: *idtype
                  constraints:
                    foreignKeyName: fk__test_order__device_type
                    references: device_type
              - column:
                  name: date_tested
                  remarks: the date the test result was submitted
                  type: DATE
                  constraints:
                    nullable: true
              - column:
                  name: order_status
                  remarks: The status of the order. "Pending" orders are the test queue; "COMPLETED" orders have results.
                  type: ${database.defaultSchemaName}.TEST_ORDER_STATUS
                  constraints:
                    nullable: false
              - column:
                  name: result
                  remarks: The result of the test, once it has been given.
                  type: ${database.defaultSchemaName}.TEST_RESULT
              - column:
                  name: test_event_id
                  type: *idtype
                  remarks: Data saved at the time the test is marked completed.
                  constraints:
                    nullable: true
                    unique: true
                    foreignKeyName: fk__test_order__test_event
                    references: test_event
                    uniqueKeyName: uk__test_order__test_event
  - changeSet:
      id: enforce-queue-uniqueness
      author: bwarfield@cdc.gov
      comment: Enforce uniqueness guarantees for patients in the queue.
      changes:
        - sql:
            remarks: Create a unique index on organization and patient, but only for PENDING orders.
            sql: |
              CREATE UNIQUE INDEX uk__test_order__organization_person_pending
              ON ${database.defaultSchemaName}.test_order (organization_id, patient_id)
              WHERE order_status = 'PENDING'
      rollback:
        sql: |
          DROP INDEX ${database.defaultSchemaName}.uk__test_order__organization_person_pending;
  - changeSet:
      id: single-race-select
      author: tbest@cdc.gov
      comment: Allow a single race selection because of HL7 only allows a single race
      changes:
        - sql:
            sql: |
              ALTER TABLE ${database.defaultSchemaName}.person
              ALTER COLUMN race TYPE text
              USING race[1];
      rollback:
        - sql:
            sql: |
              ALTER TABLE ${database.defaultSchemaName}.person
              ALTER COLUMN race TYPE text[]
              USING ARRAY[race];
  - changeSet:
      id: add-facility-table
      author: bwarfield@cdc.gov
      comment: Introduce the facility table, which takes over much of the data in the organization table
      changes:
        - createTable:
            tableName: facility
            remarks: A site where testing occurs (may be called "site" in user-facing language).
            columns:
              - column: *pk_column
              - column: *created_at_column
              - column: *created_by_column
              - column: *updated_at_column
              - column: *updated_by_column
              - column: *soft_delete_column
              - column:
                  name: organization_id
                  remarks: Foreign key to the organization that this facility belongs to.
                  type: *idtype
                  constraints:
                    nullable: false
                    foreignKeyName: fk__facility__organization
                    references: organization
              - column:
                  name: facility_name
                  type: *string
                  remarks: The human-readable name for this facility.
                  constraints:
                    nullable: false
              - column:
                  name: clia_number
                  type: *string # irony
                  remarks: The CLIA number for the facility that is ordering (and presumably also conducting) the tests.
              - column:
                  name: default_device_type_id
                  remarks: The default device type (if any) for tests at this facility.
                  type: *idtype
                  constraints:
                    foreignKeyName: fk__facility__default_device_type
                    references: device_type
              - column:
                  name: ordering_provider_id
                  type: *idtype
                  remarks: The healthcare provider who orders tests at this facility.
                  constraints:
                    nullable: false
                    foreignKeyName: fk__facility__ordering_provider
                    references: provider
              - column:
                  name: street
                  remarks: The street portion of the facility address.
                  type: "text[]"
              - column:
                  name: city
                  remarks: The city of the facility address.
                  type: *string
              - column:
                  name: county
                  remarks: The county (NOT THE COUNTRY) of the facility address, if applicable.
                  type: *string
              - column:
                  name: state
                  remarks: The state or province of the facility address.
                  type: *string
              - column:
                  name: postal_code
                  remarks: The zip/postal code of the facility address.
                  type: *string
              - column:
                  name: telephone
                  remarks: The facility's contact phone number.
                  type: *string
        - addUniqueConstraint:
            tableName: facility
            constraintName: uk__facility__organization_facility_name
            columnNames: organization_id, facility_name
  - changeSet:
      id: populate-facility-table
      author: bwarfield@cdc.gov
      comment: Populate facilities table based on existing organizations.
      preConditions:
        - onSqlOutput: FAIL
        - onFail: MARK_RAN
        - sqlCheck:
            sql: SELECT case when count(1) > 0 then 1 else 0 end FROM ${database.defaultSchemaName}.organization;
            expectedResult: 1
      changes:
        - sql:
            comment: Populate the facilities table from the organization table
            sql: |
              INSERT INTO ${database.defaultSchemaName}.facility (
                internal_id,
                organization_id,
                created_at, created_by, updated_at, updated_by, is_deleted,
                facility_name, clia_number,
                ordering_provider_id,
                default_device_type_id
              )
              SELECT
                gen_random_uuid(),
                internal_id,
                created_at, created_by, updated_at, updated_by, is_deleted,
                facility_name, clia_number,
                ordering_provider_id,
                default_device_type
              FROM ${database.defaultSchemaName}.organization;
  - changeSet:
      id: add-facility-relationships
      author: bwarfield@cdc.gov
      comment: Add relationships and otherwise modify other tables in the schema to reflect the existence of facilities.
      # we may want a check constraint on patient.facility (and arguably
      # test_order.facility and test_event.facility as well) to make sure that
      # the facility belongs to the correct organization
      changes:
        - dropConstraint:
            tableName: organization
            constraintName: uk__facility__name
        - renameColumn:
            tableName: organization
            oldColumnName: facility_name
            newColumnName: organization_name
            remarks: The human-readable name for this organization.
        - addUniqueConstraint:
            tableName: organization
            constraintName: uk__organization__organization_name
            columnNames: organization_name
        - addColumn:
            tableName: person
            columns:
              - column:
                  name: facility_id
                  afterColumn: organization_id
                  type: *idtype
                  valueComputed: (select internal_id from ${database.defaultSchemaName}.facility f where f.organization_id = organization_id)
                  remarks: The facility where this person is expected to be tested (null if they will be tested at multiple sites)
                  constraints:
                    nullable: true
                    foreignKeyName: fk__person__facility
                    referencedTableName: facility
        - addColumn:
            tableName: test_event
            columns:
              - column:
                  name: facility_id
                  afterColumn: organization_id
                  type: *idtype
                  remarks: The facility where this test took place.
                  valueComputed: (select internal_id from ${database.defaultSchemaName}.facility f where f.organization_id = organization_id)
                  constraints:
                    foreignKeyName: fk__test_event__facility
                    referencedTableName: facility
        - addNotNullConstraint:
            tableName: test_event
            columnName: facility_id
        - addColumn:
            tableName: test_order
            columns:
              - column:
                  name: facility_id
                  afterColumn: organization_id
                  type: *idtype
                  remarks: The facility where this test was ordered.
                  valueComputed: (select internal_id from ${database.defaultSchemaName}.facility f where f.organization_id = organization_id)
                  constraints:
                    foreignKeyName: fk__test_order__facility
                    referencedTableName: facility
        - addNotNullConstraint:
            tableName: test_order
            columnName: facility_id
        - addColumn:
            tableName: facility_device_type
            columns:
              - column:
                  name: facility_id
                  afterColumn: organization_id
                  type: *idtype
                  valueComputed: (select internal_id from ${database.defaultSchemaName}.facility f where f.organization_id = organization_id)
                  constraints:
                    foreignKeyName: fk__facility_device_type__facility
                    referencedTableName: facility
        - addNotNullConstraint:
            tableName: facility_device_type
            columnName: facility_id
        - dropColumn:
            tableName: facility_device_type
            columnName: organization_id
        - dropColumn:
            tableName: organization
            columns:
              - column:
                  name: clia_number
              - column:
                  name: default_device_type
              - column:
                  name: ordering_provider_id
  - changeSet:
      id: date-tested-backdate
      author: tbest@cdc.gov
      comment: add timestamp for date corrections
      changes:
        - addColumn:
            tableName: test_order
            columns:
              - column:
                  name: date_tested_backdate
                  type: DATETIME
                  remarks: timestamp to store a user correction to when the test was ordered
  - changeSet:
      id: add-facility-email
      author: nclyde@skylight.digital
      comment: add email field to facility
      changes:
        - addColumn:
            tableName: facility
            columns:
              - column:
                  name: email
                  type: *string
                  remarks: The facility's contact email address.
  - changeSet:
      id: add-data-hub-upload
      author: tnielsen2@cdc.gov
      comment: Add data_hub_upload table used to the automated results uploader.
      changes:
        - sql:
            remarks: Create the enumerations needed for DataHubUpload.
            sql: |
              CREATE TYPE ${database.defaultSchemaName}.DATA_HUB_UPLOAD_STATUS as ENUM('IN_PROGRESS', 'SUCCESS', 'FAIL');
            rollback:
              sql: |
                DROP TYPE ${database.defaultSchemaName}.DATA_HUB_UPLOAD_STATUS;
        - createTable:
            tableName: data_hub_upload
            remarks: Track uploads and results of test_events to the data-hub.
            columns:
              - column:
                  name: internal_id
                  type: *idtype
                  remarks: The internal database identifier for this entity.
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: job_status
                  type: ${database.defaultSchemaName}.DATA_HUB_UPLOAD_STATUS
                  remarks: State of this upload. Enumerated value.
                  constraints:
                    nullable: false
              - column:
                  name: created_at
                  type: DATETIME
                  remarks: The creation timestamp for this entity.
                  constraints:
                    nullable: false
              - column:
                  name: updated_at
                  type: DATETIME
                  remarks: The timestamp for the most recent update of this entity.
                  constraints:
                    nullable: false
              - column:
                  name: records_processed
                  type: int
                  remarks: Number of rows sent to the server.
              - column:
                  name: error_message
                  type: text
                  remarks: Set if an exception happens.
              - column:
                  name: response_data
                  type: jsonb
                  remarks: Response json from data-hub.
              - column:
                  name: earliest_recorded_timestamp
                  type: DATETIME
                  remarks: Lowerbound timestamp used to collect test_events. Entities with created_by > this value are sent.
              - column:
                  name: latest_recorded_timestamp
                  type: DATETIME
                  remarks: Upperbounds timestamp used to collect test_event. Entities with created_by <= this value are sent.
        - createIndex:
            indexName: uk__data_hub_upload__job_status__latest_recorded_timestamp
            tableName: data_hub_upload
            clustered: true
            columns:
              - column:
                  name: job_status
              - column:
                  name: latest_recorded_timestamp
                  descending: true
  - changeSet:
      id: change-test-results-to-MST
      author: neil.s.sharma@omb.eop.gov
      comment: Change all existing backdated tests to be midnight MST instead of midnight UTC.
      changes:
        - sql:
            comment: Update backdated test_orders from UTC to MST.
            sql: |
              UPDATE ${database.defaultSchemaName}.test_order
              SET date_tested_backdate = date_tested_backdate + interval '7' HOUR
              WHERE date_tested_backdate is not null;

  - changeSet:
      id: drop-not-null-last-seen-user
      author: jeremy.a.zitomer@omb.eop.gov
      comment: Allow user's last seen timestamp to be null to allow for other people to create users
      # Allows us to create a user without having to assign it a last-seen value (ie if user does not create themselves)
      changes:
        - dropNotNullConstraint:
            tableName: api_user
            columnName: last_seen
  - changeSet:
      id: add-swab-type-to-device-type
      author: tbest@cdc.gov
      comment: add a property to store the swab type per device
      changes:
        - addColumn:
            tableName: device_type
            columns:
              - column:
                  name: swab_type
                  type: *string
                  remarks: The swab type used for this device
                  value: "445297001" # swab of internal nose
        - addNotNullConstraint:
            tableName: device_type
            columnName: swab_type
  - changeSet:
      id: event-corrections-feature
      author: tnielsen2@cdc.gov
      comment: Add columns to existing tables to handle the concept of corrections to test_events.
      changes:
        - sql:
            remarks: Create the enumerations for corrections_status in test_event table.
            sql: |
              CREATE TYPE ${database.defaultSchemaName}.TEST_CORRECTION_STATUS as ENUM('ORIGINAL', 'CORRECTED', 'REMOVED');
            rollback:
              sql: |
                DROP TYPE ${database.defaultSchemaName}.TEST_CORRECTION_STATUS;
        - addColumn:
            tableName: test_order
            columns:
              - column:
                  name: correction_status
                  type: ${database.defaultSchemaName}.test_correction_status
                  remarks: Enumeration of type of correction. This column is used for non-delete corrections.
                  defaultValue: 'ORIGINAL'
                  value: 'ORIGINAL'
                  constraints:
                    nullable: false
              - column:
                  name: reason_for_correction
                  type: text
                  remarks: User supplied comment when a correction happens.
        - addColumn:
            tableName: test_event
            columns:
              - column:
                  name: survey_data
                  type: jsonb
                  remarks: The patient's demographics and address at the time the test was administered.
              - column:
                  name: date_tested_backdate
                  type: DATETIME
                  remarks: Timestamp to store a user correction to when the test was ordered. Copied from TestOrder. Null if not backdated.
              - column:
                  name: test_order_id
                  type: *idtype
                  remarks: Reference to original test_order internal_id.
                  constraints:
                    foreignKeyName: fk__test_event__test_order
                    referencedTableName: test_order
              - column:
                  name: correction_status
                  type: ${database.defaultSchemaName}.test_correction_status
                  remarks: Enumeration of type of correction.
                  defaultValue: 'ORIGINAL'
                  value: 'ORIGINAL'
                  constraints:
                    nullable: false
              - column:
                  name: prior_corrected_test_event_id
                  type: *idtype
                  remarks: If this is a correction, this is the id the prior test_event being corrected.
                  constraints:
                    foreignKeyName: fk__test_event__prior_corrected_test_event
                    referencedTableName: test_event
              - column:
                  name: reason_for_correction
                  type: text
                  remarks: User supplied comment when a correction happens.
        - sql:
            remarks: Copy the existing test_order_id from test_order.
            sql: |
              UPDATE ${database.defaultSchemaName}.test_event TestEvent
              SET test_order_id = TestOrder.internal_id,
                  survey_data = PatientAnswers.ask_on_entry,
                  date_tested_backdate = TestOrder.date_tested_backdate
              FROM ${database.defaultSchemaName}.test_order TestOrder
                   INNER JOIN ${database.defaultSchemaName}.patient_answers PatientAnswers
                   ON TestOrder.patient_answers_id = PatientAnswers.internal_id
              WHERE TestOrder.test_event_id = TestEvent.internal_id;
        - addNotNullConstraint:
            tableName: test_event
            columnName: test_order_id
  - changeSet:
      id: add-patient-link-table
      author: nclyde@skylight.digital
      comment: The patient link table stores time-sensitive UUIDs granting patients access to answer time of test questions
      changes:
        - createTable:
            tableName: patient_link
            remarks: Time-sensitive UUIDs granting patients access to answer time of test questions
            columns:
              - column: *pk_column
              - column: *created_at_column
              - column: *created_by_column
              - column: *updated_at_column
              - column: *updated_by_column
              - column: *soft_delete_column
              - column:
                  name: test_order_id
                  remarks: The test order this link was generated for
                  type: *idtype
                  constraints:
                    nullable: false
                    foreignKeyName: fk__patient_link__test_order
                    references: test_order
  - changeSet:
      id: add-refreshed-at-to-patient-link-table
      author: nclyde@skylight.digital
      comment: The patient link table stores time-sensitive UUIDs granting patients access to answer time of test questions
      changes:
        - addColumn:
            tableName: patient_link
            columns:
              - column:
                  name: refreshed_at
                  type: DATETIME
                  remarks: The timestamp for the most recent refresh of this entity.
  - changeSet:
      id: add-is-deleted-to-api-user
      author: jeremy.a.zitomer@omb.eop.gov
      comment: Add soft deletion flag and auditing columns to API users table
      changes:
        - addColumn:
            tableName: api_user
            # while we would love to use the proper (non-nullable) reference column below, there are 
            # already records in this table and we cannot add default values to the existing reference 
            # column without recreating it entirely
            columns:
              - column:
                  name: is_deleted
                  type: boolean
                  remarks: Flag for soft-deletion of entities (false unless the entity has been deleted).
                  defaultValueBoolean: false
                  constraints:
                    nullable: false
  - changeSet:
      id: add-swab-tables
      description: Introduce the tables necessary for tracking swab types.
      changes:
        - createTable:
            tableName: swab_type
            remarks: A type of swab/specimen collection location.
            columns:
              - column: *pk_column
              - column: *created_at_column
              - column: *created_by_column
              - column: *updated_at_column
              - column: *updated_by_column
              - column: *soft_delete_column
              - column:
                  name: name
                  type: *string
                  remarks: The name of the swab type, as displayed in isolation
                  constraints:
                    nullable: false
                    unique: true
                    uniqueConstraintName: uk__swab_type__name
              - column:
                  name: type_code
                  remarks: The SNOMED specimen type code for this swab type.
                  type: *string
                  constraints:
                    nullable: false
                    unique: true
                    uniqueConstraintName: uk__swab_type__type_code
        - createTable:
            tableName: device_swab
            remarks: A usable combination of device type and swab type.
            columns:
              - column: *pk_column
              - column: *created_at_column
              - column: *created_by_column
              - column: *updated_at_column
              - column: *updated_by_column
              - column: *soft_delete_column
              - column:
                  name: device_type_id
                  type: *idtype
                  constraints:
                    nullable: false
                    foreignKeyName: fk__device_swab__device_type
                    references: device_type
              - column:
                  name: swab_type_id
                  type: *idtype
                  constraints:
                    nullable: false
                    foreignKeyName: fk__device_swab__swab_type
                    references: swab_type
        - addUniqueConstraint:
            tableName: device_swab
            constraintName: uk__device_swab
            columnNames: device_type_id, swab_type_id
        - createTable:
            tableName: facility_device_swab
            remarks: Many-to-many table for device/swab configuration at a facility.
            columns:
              - column:
                  name: facility_id
                  type: *idtype
                  constraints:
                    nullable: false
                    foreignKeyName: fk__facility_device_swab__facility
                    references: facility
              - column:
                  name: device_swab_id
                  type: *idtype
                  constraints:
                    nullable: false
                    foreignKeyName: fk__facility_device_swab__device_swab
                    references: device_swab
        - addUniqueConstraint:
            tableName: facility_device_swab
            constraintName: uk__facility_device_swab
            columnNames: facility_id, device_swab_id
        - addColumn:
            tableName: facility
            columns:
              - column:
                  name: default_device_swab_id
                  type: *idtype
                  constraints:
                    foreignKeyName: fk__facility__default_device_swab
                    referencedTableName: device_swab
        - addColumn:
            tableName: test_order
            columns:
              - column:
                  name: device_swab_id
                  remarks: The device/swab combination used to record the test result.
                  type: *idtype
                  constraints:
                    foreignKeyName: fk__test_order__device_swab
                    referencedTableName: device_swab
                    # will be made non-null in a subsequent migration
        - addColumn:
            tableName: test_event
            columns:
              - column:
                  name: device_swab_id
                  remarks: The device/swab combination used to record the test result.
                  type: *idtype
                  constraints:
                    foreignKeyName: fk__test_event__device_swab
                    referencedTableName: device_swab
                    # will be made non-null in a subsequent migration
  - changeSet:
      id: populate-specimen-tables
      author: bwarfield@cdc.gov
      comment: Populate specimen tables and relations based on existing data.
      preConditions:
        - onSqlOutput: FAIL
        - onFail: MARK_RAN
        - sqlCheck:
            sql:  SELECT case when count(1) > 0 then 1 else 0 end FROM ${database.defaultSchemaName}.device_type;
            expectedResult: 1
      changes:
        - sql:
          remarks: Create migrations user to indicate records created by migration rather than by a human.
          sql: |
            INSERT INTO ${database.defaultSchemaName}.api_user
            (internal_id, created_at, updated_at, last_seen, login_email, last_name)
            VALUES (
              gen_random_uuid(), now(), now(), null,
              '${migration_user_email}', 'Database Migration Process'
            )
        - sql:
          remarks: Create default specimen type for known devices at the time of this migration.
          sql: |
            WITH specimen_types_historical as (
              select distinct swab_type as type_code from ${database.defaultSchemaName}.device_type
            ),
            migration_user as (
              SELECT internal_id as migrations_user_id
              FROM ${database.defaultSchemaName}.api_user 
              WHERE login_email = '${migrations_user_email}'
            )
            INSERT INTO ${database.defaultSchemaName}.specimen_type (name, type_code,
              internal_id, created_at, created_by, updated_at, updated_by, is_deleted)
            SELECT (
              'Auto-generated specimen type ' || type_code,
              type_code,
              gen_random_uuid(),
              migrations_user_id,
              now(),
              migrations_user_id,
              now(),
              false             
            )
            FROM specimen_types_historical cross join migration_user
        - sql:
          remarks: Add device_specimen and facility_device_specimen entries based on existing data, and populate facility.default_device_specimen_id.
          sql: |
            WITH device_swab_historical as (
              SELECT dt.internal_id device_type_id, swt.internal_id specimen_type_id
              FROM ${database.defaultSchemaName}.device_type dt
               JOIN ${database.defaultSchemaName}.specimen_type swt ON dt.swab_type = swt.type_code 
            ),
            migration_user as (
              SELECT internal_id as migrations_user_id
              FROM ${database.defaultSchemaName}.api_user 
              WHERE login_email = '${migrations_user_email}'
            )
            
            INSERT INTO ${database.defaultSchemaName}.device_specimen
            ( internal_id,               
              created_at, created_by, updated_at, updated_by, is_deleted,
            )
            SELECT
              gen_random_uuid(),
              now(), migration_user_id, now(), migration_user_id, false
            FROM device_swab_historical cross join migration_user 
  - changeSet:
      id: complete-specimen-column-additions
      author: bwarfield@cdc.gov
      comment: Update constraints for newly-added columns referencing device_specimen.
      changes:
        - addNotNullConstraint:
            tableName: test_event
            columnName: device_specimen_id
        - addNotNullConstraint:
            tableName: test_order
            columnName: device_specimen_id
