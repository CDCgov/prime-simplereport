name: Run Cypress integration tests on a remote environment
description: Run integration tests on a remote environment

# env vars required
# CYPRESS_OKTA_USERNAME
# CYPRESS_OKTA_PASSWORD
# CYPRESS_OKTA_SECRET
# CYPRESS_BASE_URL
# E2E_SPEC_FILES
# DEPLOY_ENV

runs:
  using: composite
  steps:
    - name: "Use Node.js ${{ env.NODE_VERSION }}"
      uses: "actions/setup-node@v2.1.5"
      with:
        node-version: ${{ env.NODE_VERSION }}
    - name: Cache yarn
      uses: actions/cache@v2
      with:
        path: ~/.cache/yarn
        key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
        restore-keys: |
          ${{ runner.os }}-yarn-
    - name: Cache Cypress binary
      uses: actions/cache@v2
      with:
        path: ~/.cache/Cypress
        key: cypress-${{ runner.os }}-cypress-${{ hashFiles('**/package.json') }}
        restore-keys: |
          cypress-${{ runner.os }}-cypress-
    - name: Makefile deploy verification for backend in ${{env.DEPLOY_ENV}} environment
      shell: bash
      working-directory: ./ops
      env:
          CURL_TIMEOUT: 5
      run: |
        echo "::group::Run Makefile verification"
        make check-${{env.DEPLOY_ENV}}-commit check-${{env.DEPLOY_ENV}}-readiness
        echo "::endgroup::"
    - name: install dependencies and verify Cypress
      shell: bash
      working-directory: ./frontend
      env:
        # make sure every Cypress install prints minimal information
        CI: 1
      run: |
        yarn install --prefer-offline
        yarn exec cypress verify
        yarn exec cypress version
        yarn exec cypress version --component package
        yarn exec cypress version --component binary
        yarn exec cypress version --component electron
        yarn exec cypress version --component node
    - name: Cypress deploy verification for frontend in ${{env.DEPLOY_ENV}} environment
      shell: bash
      working-directory: ./frontend
      run: |
        echo "::group::Run Cypress verification"
        ./e2e.sh -s "${{ env.E2E_SPEC_FILES }}" -r ${{ env.CYPRESS_BASE_URL }} -f /health/commit -p /app
        echo "::endgroup::"
    - name: Archive cypress screenshots and videos
      uses: actions/upload-artifact@v3
      if: failure()
      with:
        name: cypress-artifacts
        path: |
          ./frontend/cypress/screenshots/
        retention-days: 5